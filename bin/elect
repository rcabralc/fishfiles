#!/usr/bin/env python
from docopt import docopt
from json import dumps as dumpjson

import elect
import sys


def main():
    args = docopt(elect.__doc__)

    patterns = args['PATTERNS']
    limit = args['--limit']
    sort_limit = args['--sort-limit']
    options = {}

    if limit is not False and limit is not None:
        options['limit'] = int(limit)

    if sort_limit is not False and sort_limit is not None:
        options['sort_limit'] = int(sort_limit)

    if args['--ignore-bad-patterns']:
        options['ignore_bad_patterns'] = True

    if args['--reverse']:
        options['reverse'] = True

    strip = str.strip
    entries = (strip(line) for line in iter(sys.stdin.readline, ''))
    terms = (elect.Term(i, c) for i, c in enumerate(entries, start=1) if c)
    results = elect.filter_entries(terms, *patterns, **options)

    for result in results:
        if args['--output-json']:
            line = dumpjson(result.asdict())
        else:
            line = elect.build_line(result, highlight=not args['--no-color'])
        print(line)

    return 0


if __name__ == '__main__':
    sys.exit(main())
